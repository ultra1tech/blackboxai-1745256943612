<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seller Dashboard - Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-indigo-600">Seller Dashboard</h1>
      <nav class="space-x-4">
        <a href="index.html" class="text-gray-700 hover:text-indigo-600">Home</a>
        <a href="shop.html" class="text-gray-700 hover:text-indigo-600">Shop</a>
        <a href="seller-dashboard.html" class="text-indigo-600 font-semibold">Dashboard</a>
        <a href="login.html" class="text-gray-700 hover:text-indigo-600">Logout</a>
      </nav>
    </div>
  </header>

  <!-- Dashboard Content -->
  <section class="container mx-auto px-4 py-12">
    <h2 class="text-2xl font-bold mb-6">Manage Your Products</h2>
    <button id="add-product-btn" class="mb-6 bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700 transition">Add New Product</button>
    <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      <!-- Products will be loaded here -->
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 id="modal-title" class="text-xl font-semibold mb-4">Add Product</h3>
        <form id="product-form" class="space-y-4">
          <input type="hidden" id="product-id" />
          <div>
            <label for="title" class="block font-semibold mb-1">Title</label>
            <input type="text" id="title" required class="w-full border border-gray-300 rounded p-2" />
          </div>
          <div>
            <label for="description" class="block font-semibold mb-1">Description</label>
            <textarea id="description" class="w-full border border-gray-300 rounded p-2"></textarea>
          </div>
          <div>
            <label for="price" class="block font-semibold mb-1">Price</label>
            <input type="number" id="price" step="0.01" required class="w-full border border-gray-300 rounded p-2" />
          </div>
          <div>
            <label for="currency" class="block font-semibold mb-1">Currency</label>
            <input type="text" id="currency" value="USD" class="w-full border border-gray-300 rounded p-2" />
          </div>
          <div>
            <label for="image_url" class="block font-semibold mb-1">Image URL</label>
            <input type="url" id="image_url" class="w-full border border-gray-300 rounded p-2" />
          </div>
          <div class="flex justify-end space-x-4">
            <button type="button" id="cancel-btn" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100">Cancel</button>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Save</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script>
    const token = localStorage.getItem('access_token');
    if (!token) {
      alert('Please login to access the seller dashboard.');
      window.location.href = 'login.html';
    }

    const productsContainer = document.getElementById('products-container');
    const productModal = document.getElementById('product-modal');
    const productForm = document.getElementById('product-form');
    const modalTitle = document.getElementById('modal-title');
    const cancelBtn = document.getElementById('cancel-btn');
    const addProductBtn = document.getElementById('add-product-btn');

    async function fetchProducts() {
      try {
        const response = await fetch('http://localhost:8000/products/', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!response.ok) throw new Error('Failed to fetch products');
        const products = await response.json();
        renderProducts(products);
      } catch (error) {
        productsContainer.innerHTML = '<p class="text-red-500">Failed to load products.</p>';
      }
    }

    function renderProducts(products) {
      productsContainer.innerHTML = '';
      products.forEach(product => {
        const div = document.createElement('div');
        div.className = 'bg-white rounded-lg shadow p-4 hover:shadow-lg transition cursor-pointer';
        div.innerHTML = `
          <img src="${product.image_url || 'https://via.placeholder.com/300x200'}" alt="${product.title}" class="rounded-md mb-4 w-full object-cover" />
          <h4 class="font-semibold mb-1">${product.title}</h4>
          <p class="text-indigo-600 font-bold mb-1">$${product.price.toFixed(2)}</p>
          <p class="text-gray-500 text-sm">Currency: ${product.currency}</p>
          <div class="flex justify-between mt-4">
            <button class="text-indigo-600 hover:underline" onclick="editProduct(${product.id})">Edit</button>
            <button class="text-red-600 hover:underline" onclick="deleteProduct(${product.id})">Delete</button>
          </div>
        `;
        productsContainer.appendChild(div);
      });
    }

    addProductBtn.addEventListener('click', () => {
      modalTitle.textContent = 'Add Product';
      productForm.reset();
      productForm['product-id'].value = '';
      productModal.classList.remove('hidden');
    });

    cancelBtn.addEventListener('click', () => {
      productModal.classList.add('hidden');
    });

    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = productForm['product-id'].value;
      const productData = {
        title: productForm.title.value,
        description: productForm.description.value,
        price: parseFloat(productForm.price.value),
        currency: productForm.currency.value,
        image_url: productForm.image_url.value,
      };
      try {
        let response;
        if (id) {
          response = await fetch(`http://localhost:8000/products/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token,
            },
            body: JSON.stringify(productData),
          });
        } else {
          response = await fetch('http://localhost:8000/products/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token,
            },
            body: JSON.stringify(productData),
          });
        }
        if (!response.ok) throw new Error('Failed to save product');
        productModal.classList.add('hidden');
        fetchProducts();
      } catch (error) {
        alert(error.message);
      }
    });

    async function editProduct(id) {
      try {
        const response = await fetch(`http://localhost:8000/products/${id}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!response.ok) throw new Error('Failed to fetch product');
        const product = await response.json();
        modalTitle.textContent = 'Edit Product';
        productForm['product-id'].value = product.id;
        productForm.title.value = product.title;
        productForm.description.value = product.description || '';
        productForm.price.value = product.price;
        productForm.currency.value = product.currency;
        productForm.image_url.value = product.image_url || '';
        productModal.classList.remove('hidden');
      } catch (error) {
        alert(error.message);
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      try {
        const response = await fetch(`http://localhost:8000/products/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!response.ok) throw new Error('Failed to delete product');
        fetchProducts();
      } catch (error) {
        alert(error.message);
      }
    }

    fetchProducts();
  </script>
</body>
</html>
