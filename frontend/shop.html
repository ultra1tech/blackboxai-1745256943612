<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - GlobalMarket</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .product-card:hover .quick-view {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <!-- Logo -->
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/" class="text-2xl font-bold text-indigo-600">GlobalMarket</a>
                    </div>
                    
                    <!-- Navigation Links -->
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/shop.html" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 text-sm font-medium">Shop</a>
                        <a href="#categories" class="text-gray-700 hover:text-indigo-600 px-3 py-2 text-sm font-medium">Categories</a>
                        <a href="#sellers" class="text-gray-700 hover:text-indigo-600 px-3 py-2 text-sm font-medium">Sellers</a>
                    </div>
                </div>
                
                <!-- Right Side Navigation -->
                <div class="flex items-center space-x-4">
                    <!-- Search -->
                    <div class="flex-1 flex items-center justify-center px-2 lg:ml-6 lg:justify-end">
                        <div class="max-w-lg w-full lg:max-w-xs">
                            <label for="search" class="sr-only">Search products</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input id="search" name="search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm" placeholder="Search products" type="search">
                            </div>
                        </div>
                    </div>

                    <!-- Cart -->
                    <button class="relative p-2 text-gray-700 hover:text-indigo-600">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount" class="absolute top-0 right-0 -mt-1 -mr-1 px-2 py-1 text-xs font-bold leading-none text-white bg-red-500 rounded-full">0</span>
                    </button>

                    <!-- Wishlist -->
                    <button class="p-2 text-gray-700 hover:text-indigo-600">
                        <i class="fas fa-heart"></i>
                    </button>

                    <!-- User Menu -->
                    <div class="ml-3 relative">
                        <div>
                            <button type="button" id="userMenuBtn" class="flex text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-user-circle text-2xl text-gray-700 hover:text-indigo-600"></i>
                            </button>
                        </div>
                        <div id="userMenu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5">
                            <a href="/login.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign in</a>
                            <a href="/register.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Register</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Filters Sidebar -->
            <div class="w-full md:w-64 flex-shrink-0">
                <div class="bg-white rounded-lg shadow p-6 sticky top-24">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
                    
                    <!-- Categories -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-2">Categories</h4>
                        <div class="space-y-2" id="categoryFilters">
                            <!-- Populated via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Price Range -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-2">Price Range</h4>
                        <div class="space-y-2">
                            <div>
                                <label class="sr-only">Min Price</label>
                                <input type="number" id="minPrice" placeholder="Min" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="sr-only">Max Price</label>
                                <input type="number" id="maxPrice" placeholder="Max" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rating -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-2">Rating</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="rating" value="4" class="h-4 w-4 text-indigo-600">
                                <span class="ml-2">4★ & up</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="rating" value="3" class="h-4 w-4 text-indigo-600">
                                <span class="ml-2">3★ & up</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Location -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-2">Seller Location</h4>
                        <select id="location" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">All Locations</option>
                            <!-- Populated via JavaScript -->
                        </select>
                    </div>
                    
                    <!-- Apply Filters Button -->
                    <button id="applyFilters" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">
                        Apply Filters
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1">
                <!-- Sort and View Options -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <label class="mr-2 text-sm text-gray-700">Sort by:</label>
                        <select id="sortBy" class="border border-gray-300 rounded-md px-3 py-1.5">
                            <option value="newest">Newest</option>
                            <option value="price_asc">Price: Low to High</option>
                            <option value="price_desc">Price: High to Low</option>
                            <option value="rating">Rating</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="p-2 text-gray-600 hover:text-indigo-600" id="gridView">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="p-2 text-gray-600 hover:text-indigo-600" id="listView">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Products populated via JavaScript -->
                </div>

                <!-- Loading State -->
                <div id="loading" class="hidden">
                    <div class="flex justify-center items-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    </div>
                </div>

                <!-- Load More -->
                <div class="text-center mt-8">
                    <button id="loadMore" class="bg-white text-indigo-600 px-6 py-2 rounded-md border border-indigo-600 hover:bg-indigo-50">
                        Load More
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75"></div>
        <div class="fixed inset-0 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <!-- Modal content populated via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let isLoading = false;
        const productsPerPage = 12;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadLocations();
            loadProducts();
            setupEventListeners();
            checkAuthStatus();
        });

        async function loadCategories() {
            try {
                const response = await fetch('http://localhost:8000/api/categories');
                const categories = await response.json();
                
                const categoryFilters = document.getElementById('categoryFilters');
                categories.forEach(category => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="flex items-center">
                            <input type="checkbox" value="${category.id}" class="h-4 w-4 text-indigo-600">
                            <span class="ml-2">${category.name}</span>
                        </label>
                    `;
                    categoryFilters.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function loadLocations() {
            const locations = [
                "United States", "United Kingdom", "Canada", "Australia", "Germany", 
                "France", "Italy", "Spain", "Japan", "China", "India"
            ].sort();
            
            const locationSelect = document.getElementById('location');
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
        }

        async function loadProducts(reset = false) {
            if (isLoading) return;
            if (reset) currentPage = 1;
            
            isLoading = true;
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                // Get filter values
                const search = document.getElementById('search').value;
                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;
                const rating = document.querySelector('input[name="rating"]:checked')?.value;
                const location = document.getElementById('location').value;
                const sortBy = document.getElementById('sortBy').value;
                const selectedCategories = Array.from(document.querySelectorAll('#categoryFilters input:checked')).map(cb => cb.value);
                
                // Build query parameters
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: productsPerPage,
                    sort_by: sortBy
                });
                
                if (search) params.append('search', search);
                if (minPrice) params.append('min_price', minPrice);
                if (maxPrice) params.append('max_price', maxPrice);
                if (rating) params.append('min_rating', rating);
                if (location) params.append('seller_country', location);
                if (selectedCategories.length) params.append('categories', selectedCategories.join(','));
                
                const response = await fetch(`http://localhost:8000/api/products?${params}`);
                const products = await response.json();
                
                const productsGrid = document.getElementById('productsGrid');
                if (reset) productsGrid.innerHTML = '';
                
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
                
                // Show/hide load more button
                document.getElementById('loadMore').style.display = products.length < productsPerPage ? 'none' : 'block';
                
            } catch (error) {
                console.error('Error loading products:', error);
            } finally {
                isLoading = false;
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function createProductCard(product) {
            const div = document.createElement('div');
            div.className = 'product-card bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300';
            div.innerHTML = `
                <div class="relative">
                    <img src="${product.image_urls ? JSON.parse(product.image_urls)[0] : 'https://via.placeholder.com/300'}" 
                         alt="${product.title}" 
                         class="w-full h-48 object-cover">
                    <div class="quick-view hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center">
                        <button class="bg-white text-gray-900 px-4 py-2 rounded-md hover:bg-gray-100"
                                onclick="showQuickView(${product.id})">
                            Quick View
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.title}</h3>
                    <p class="text-gray-600 text-sm mb-2 line-clamp-2">${product.description}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-bold text-indigo-600">$${product.price}</span>
                        <div class="flex items-center">
                            <span class="text-yellow-400">${'★'.repeat(Math.round(product.rating || 0))}</span>
                            <span class="text-gray-400">${'★'.repeat(5-Math.round(product.rating || 0))}</span>
                        </div>
                    </div>
                    <button onclick="addToCart(${product.id})" 
                            class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">
                        Add to Cart
                    </button>
                </div>
            `;
            return div;
        }

        async function showQuickView(productId) {
            try {
                const response = await fetch(`http://localhost:8000/api/products/${productId}`);
                const product = await response.json();
                
                const modal = document.getElementById('quickViewModal');
                const content = modal.querySelector('.bg-white');
                
                content.innerHTML = `
                    <div class="flex">
                        <div class="w-1/2">
                            <img src="${product.image_urls ? JSON.parse(product.image_urls)[0] : 'https://via.placeholder.com/300'}" 
                                 alt="${product.title}" 
                                 class="w-full h-64 object-cover rounded-lg">
                        </div>
                        <div class="w-1/2 pl-6">
                            <h2 class="text-2xl font-bold text-gray-900">${product.title}</h2>
                            <p class="mt-2 text-gray-600">${product.description}</p>
                            <div class="mt-4">
                                <span class="text-2xl font-bold text-indigo-600">$${product.price}</span>
                            </div>
                            <div class="mt-4 flex items-center">
                                <span class="text-yellow-400">${'★'.repeat(Math.round(product.rating || 0))}</span>
                                <span class="text-gray-400">${'★'.repeat(5-Math.round(product.rating || 0))}</span>
                            </div>
                            <button onclick="addToCart(${product.id})" 
                                    class="mt-6 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="closeQuickView()" 
                                class="text-gray-600 hover:text-gray-900">
                            Close
                        </button>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error showing quick view:', error);
            }
        }

        function closeQuickView() {
            document.getElementById('quickViewModal').classList.add('hidden');
        }

        function setupEventListeners() {
            // Search
            let searchTimeout;
            document.getElementById('search').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => loadProducts(true), 500);
            });
            
            // Filters
            document.getElementById('applyFilters').addEventListener('click', () => loadProducts(true));
            
            // Sort
            document.getElementById('sortBy').addEventListener('change', () => loadProducts(true));
            
            // Load More
            document.getElementById('loadMore').addEventListener('click', () => {
                currentPage++;
                loadProducts();
            });
            
            // View Toggle
            document.getElementById('gridView').addEventListener('click', () => {
                document.getElementById('productsGrid').className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
            });
            
            document.getElementById('listView').addEventListener('click', () => {
                document.getElementById('productsGrid').className = 'grid grid-cols-1 gap-6';
            });
            
            // User Menu
            document.getElementById('userMenuBtn').addEventListener('click', () => {
                document.getElementById('userMenu').classList.toggle('hidden');
            });
            
            // Close Quick View on outside click
            document.getElementById('quickViewModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeQuickView();
                }
            });
        }

        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            const userMenu = document.getElementById('userMenu');
            if (token && user) {
                userMenu.innerHTML = `
                    <a href="${user.user_type === 'seller' ? '/seller-dashboard.html' : '/buyer-dashboard.html'}" 
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        Dashboard
                    </a>
                    <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        Sign out
                    </a>
                `;
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        function addToCart(productId) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // Implement cart functionality
            const cartCount = document.getElementById('cartCount');
            cartCount.textContent = parseInt(cartCount.textContent) + 1;
        }
    </script>
</body>
</html>
